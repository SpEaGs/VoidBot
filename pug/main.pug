doctype html
html
    head
        include ./css/main-css.pug
        title VoidBot Dashboard
        include ./header.pug
    body
        script(src='/dash/node_modules/socket.io-client/dist/socket.io.dev.js')
        #errPopup.popup.hidden
            .popupItem Error connecting to VoidBot. Attempting to reconnect...
        #popupNewGuild.popup.hidden
            .popupItem There has been an update to either the webpage or the bot. Please refresh your page.
        h2.pageTitle Home
        .mainContentContainer
            .mainArticle
                h2 Welcome to VoidBot's Web UI!
                h3 There's not much to see here right now since there are no features for non-admin users here yet...
                h3 But if you ARE an admin, you can click the button below to jump right to the admin panel!
                script#u(u=user).
                    let thisScript = document.getElementById('u')
                    let user = JSON.parse(thisScript.getAttribute('u'));
                    setTimeout( () => {thisScript.removeAttribute('u');}, 2000);
                    const socket = io(`http://${window.location.hostname}:7777`);
                    socket.once('connect', () => {
                        socket.emit('getBotInfo', user.guilds.member);
                    });
                    socket.on('connect_error', (err) => {
                        console.log('Connection Error: (Will attempt to reconnect)');
                        console.warn(err);
                        document.getElementById('errPopup').classList.remove('hidden');
                    });
                    socket.on('reconnect', (n) => {
                        console.log(`Reconnected after ${n} attempts.`);
                        document.getElementById('errPopup').classList.add('hidden');
                    });

                    function addGuild(bot) {
                        let ctrl = document.createElement('div');
                            ctrl.id = `gCtrl${bot.guildID}`;
                            ctrl.classList.add('guildController');
                        let url = document.createElement('input');
                            url.id = `gcURLInput${bot.guildID}`;
                            url.type = 'url';
                            url.classList.add('gcURLInput');
                            url.placeholder = 'Youtube or SoundCloud link here';
                            ctrl.appendChild(url);
                        document.getElementById('guildControlsContainer').appendChild(ctrl);
                    };
                    socket.on('sendBotInfo', (bots) => {
                        for (let b of bots) {
                            addGuild(b);
                        };
                    });
            a.articleButton(href='/dash/admin')
                .navlinkText Admin Panel
            .articleItem#guildControlsContainer

    footer
        include ./footer.pug